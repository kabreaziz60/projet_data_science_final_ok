{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Chatbot de Support Technique</title>
    <style>
        /* CSS très simple pour la mise en page */
        body { font-family: Arial, sans-serif; }
        #chat-window { border: 1px solid #ccc; height: 400px; overflow-y: scroll; padding: 10px; margin-bottom: 10px; }
        .user-msg { text-align: right; color: blue; }
        .bot-msg { text-align: left; color: green; }
    </style>
</head>
<body>
    <h1>Chatbot de Support Technique</h1>
    <div id="chat-window">
        <div class="bot-msg">Bonjour! Je suis là pour vous aider avec vos problèmes informatiques.</div>
    </div>

    <form id="chat-form">
        {% csrf_token %} <input type="text" id="user-input" placeholder="Tapez votre question ici..." style="width: 80%;">
        <button type="submit">Envoyer</button>
    </form>

    <script>
        document.getElementById('chat-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const userInput = document.getElementById('user-input');
            const message = userInput.value.trim();

            if (message === '') return;

            const chatWindow = document.getElementById('chat-window');

            // 1. Affiche le message de l'utilisateur
            chatWindow.innerHTML += `<div class="user-msg">Vous: ${message}</div>`;
            chatWindow.scrollTop = chatWindow.scrollHeight; // Fait défiler vers le bas
            userInput.value = ''; // Efface le champ

            // 2. Envoi du message au backend Django via AJAX
            fetch("{% url 'get_chatbot_response' %}", {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                // Le corps du POST doit être encodé comme un formulaire
                body: `message=${encodeURIComponent(message)}` 
            })
            .then(response => response.json())
            .then(data => {
                // 3. Affiche la réponse du bot
                const botResponse = data.message;
                chatWindow.innerHTML += `<div class="bot-msg">Chatbot: ${botResponse}</div>`;
                chatWindow.scrollTop = chatWindow.scrollHeight;
            })
            .catch(error => {
                console.error('Erreur:', error);
                chatWindow.innerHTML += `<div class="bot-msg" style="color: red;">Erreur de connexion.</div>`;
                chatWindow.scrollTop = chatWindow.scrollHeight;
            });
        });
    </script>
</body>
</html>